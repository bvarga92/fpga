#include "oled.h"
#include "xparameters.h"
#include "xgpiops.h"
#include "xspips.h"

static const uint8_t font[]={
	0x00, 0x00, 0x00, 0x00, 0x00, // space
	0x00, 0x00, 0x4f, 0x00, 0x00, // !
	0x00, 0x03, 0x00, 0x03, 0x00, // "
	0x14, 0x3e, 0x14, 0x3e, 0x14, // #
	0x24, 0x2a, 0x7f, 0x2a, 0x12, // $
	0x63, 0x13, 0x08, 0x64, 0x63, // %
	0x36, 0x49, 0x55, 0x22, 0x50, // &
	0x00, 0x00, 0x07, 0x00, 0x00, // '
	0x00, 0x1c, 0x22, 0x41, 0x00, // (
	0x00, 0x41, 0x22, 0x1c, 0x00, // )
	0x0a, 0x04, 0x1f, 0x04, 0x0a, // *
	0x04, 0x04, 0x1f, 0x04, 0x04, // +
	0x50, 0x30, 0x00, 0x00, 0x00, // ,
	0x08, 0x08, 0x08, 0x08, 0x08, // -
	0x60, 0x60, 0x00, 0x00, 0x00, // .
	0x00, 0x60, 0x1c, 0x03, 0x00, // /
	0x3e, 0x41, 0x49, 0x41, 0x3e, // 0
	0x00, 0x02, 0x7f, 0x00, 0x00, // 1
	0x46, 0x61, 0x51, 0x49, 0x46, // 2
	0x21, 0x49, 0x4d, 0x4b, 0x31, // 3
	0x18, 0x14, 0x12, 0x7f, 0x10, // 4
	0x4f, 0x49, 0x49, 0x49, 0x31, // 5
	0x3e, 0x51, 0x49, 0x49, 0x32, // 6
	0x01, 0x01, 0x71, 0x0d, 0x03, // 7
	0x36, 0x49, 0x49, 0x49, 0x36, // 8
	0x26, 0x49, 0x49, 0x49, 0x3e, // 9
	0x00, 0x33, 0x33, 0x00, 0x00, // :
	0x00, 0x53, 0x33, 0x00, 0x00, // ;
	0x00, 0x08, 0x14, 0x22, 0x41, // <
	0x14, 0x14, 0x14, 0x14, 0x14, // =
	0x41, 0x22, 0x14, 0x08, 0x00, // >
	0x06, 0x01, 0x51, 0x09, 0x06, // ?
	0x3e, 0x41, 0x49, 0x15, 0x1e, // @
	0x78, 0x16, 0x11, 0x16, 0x78, // A
	0x7f, 0x49, 0x49, 0x49, 0x36, // B
	0x3e, 0x41, 0x41, 0x41, 0x22, // C
	0x7f, 0x41, 0x41, 0x41, 0x3e, // D
	0x7f, 0x49, 0x49, 0x49, 0x49, // E
	0x7f, 0x09, 0x09, 0x09, 0x09, // F
	0x3e, 0x41, 0x41, 0x49, 0x7b, // G
	0x7f, 0x08, 0x08, 0x08, 0x7f, // H
	0x00, 0x00, 0x7f, 0x00, 0x00, // I
	0x38, 0x40, 0x40, 0x41, 0x3f, // J
	0x7f, 0x08, 0x08, 0x14, 0x63, // K
	0x7f, 0x40, 0x40, 0x40, 0x40, // L
	0x7f, 0x06, 0x18, 0x06, 0x7f, // M
	0x7f, 0x06, 0x18, 0x60, 0x7f, // N
	0x3e, 0x41, 0x41, 0x41, 0x3e, // O
	0x7f, 0x09, 0x09, 0x09, 0x06, // P
	0x3e, 0x41, 0x51, 0x21, 0x5e, // Q
	0x7f, 0x09, 0x19, 0x29, 0x46, // R
	0x26, 0x49, 0x49, 0x49, 0x32, // S
	0x01, 0x01, 0x7f, 0x01, 0x01, // T
	0x3f, 0x40, 0x40, 0x40, 0x7f, // U
	0x0f, 0x30, 0x40, 0x30, 0x0f, // V
	0x1f, 0x60, 0x1c, 0x60, 0x1f, // W
	0x63, 0x14, 0x08, 0x14, 0x63, // X
	0x03, 0x04, 0x78, 0x04, 0x03, // Y
	0x61, 0x51, 0x49, 0x45, 0x43, // Z
	0x00, 0x7f, 0x41, 0x00, 0x00, // [
	0x03, 0x1c, 0x60, 0x00, 0x00, // back/
	0x00, 0x41, 0x7f, 0x00, 0x00, // ]
	0x0c, 0x02, 0x01, 0x02, 0x0c, // ^
	0x40, 0x40, 0x40, 0x40, 0x40, // _
	0x00, 0x01, 0x02, 0x04, 0x00, // `
	0x20, 0x54, 0x54, 0x54, 0x78, // a
	0x7f, 0x48, 0x44, 0x44, 0x38, // b
	0x38, 0x44, 0x44, 0x44, 0x44, // c
	0x38, 0x44, 0x44, 0x48, 0x7f, // d
	0x38, 0x54, 0x54, 0x54, 0x18, // e
	0x08, 0x7e, 0x09, 0x09, 0x00, // f
	0x0c, 0x52, 0x52, 0x54, 0x3e, // g
	0x7f, 0x08, 0x04, 0x04, 0x78, // h
	0x00, 0x00, 0x7d, 0x00, 0x00, // i
	0x00, 0x40, 0x3d, 0x00, 0x00, // j
	0x7f, 0x10, 0x28, 0x44, 0x00, // k
	0x00, 0x00, 0x3f, 0x40, 0x00, // l
	0x7c, 0x04, 0x18, 0x04, 0x78, // m
	0x7c, 0x08, 0x04, 0x04, 0x78, // n
	0x38, 0x44, 0x44, 0x44, 0x38, // o
	0x7f, 0x12, 0x11, 0x11, 0x0e, // p
	0x0e, 0x11, 0x11, 0x12, 0x7f, // q
	0x00, 0x7c, 0x08, 0x04, 0x04, // r
	0x48, 0x54, 0x54, 0x54, 0x24, // s
	0x04, 0x3e, 0x44, 0x44, 0x00, // t
	0x3c, 0x40, 0x40, 0x20, 0x7c, // u
	0x1c, 0x20, 0x40, 0x20, 0x1c, // v
	0x1c, 0x60, 0x18, 0x60, 0x1c, // w
	0x44, 0x28, 0x10, 0x28, 0x44, // x
	0x46, 0x28, 0x10, 0x08, 0x06, // y
	0x44, 0x64, 0x54, 0x4c, 0x44, // z
	0x00, 0x08, 0x77, 0x41, 0x00, // {
	0x00, 0x00, 0x7f, 0x00, 0x00, // |
	0x00, 0x41, 0x77, 0x08, 0x00, // }
	0x10, 0x08, 0x18, 0x10, 0x08  // ~
};

static XGpioPs gpio;
static XSpiPs spi;
static uint8_t oledIsOn=0;
static uint8_t cursorX=0, cursorY=0;
uint8_t oledFrameBuffer[512];

void oledInit(void){
	XGpioPs_Config *gpioConfig;
	XSpiPs_Config *spiConfig;
	volatile uint32_t i;
	uint8_t initCommands[25]={0xAE,0xD5,0x80,0xA8,0x1F,
	                          0xD3,0x00,0x40,0x8D,0x14,
	                          0x20,0x00,0xA0,0xC0,0xDA,
	                          0x02,0x81,0x8F,0xD9,0xF1,
	                          0xDB,0x40,0xA4,0xA6,0xAF};
	/* GPIO */
	gpioConfig=XGpioPs_LookupConfig(XPAR_PS7_GPIO_0_DEVICE_ID);
	XGpioPs_CfgInitialize(&gpio,gpioConfig,gpioConfig->BaseAddr);
	XGpioPs_SetDirectionPin(&gpio,PIN_RES,1);
	XGpioPs_SetOutputEnablePin(&gpio,PIN_RES,1);
	XGpioPs_SetDirectionPin(&gpio,PIN_VDD,1);
	XGpioPs_SetOutputEnablePin(&gpio,PIN_VDD,1);
	XGpioPs_SetDirectionPin(&gpio,PIN_VBAT,1);
	XGpioPs_SetOutputEnablePin(&gpio,PIN_VBAT,1);
	XGpioPs_SetDirectionPin(&gpio,PIN_DC,1);
	XGpioPs_SetOutputEnablePin(&gpio,PIN_DC,1);
	/* power-up szekvencia */
	XGpioPs_WritePin(&gpio,PIN_RES,0);
	XGpioPs_WritePin(&gpio,PIN_VDD,0);
	XGpioPs_WritePin(&gpio,PIN_VBAT,1);
	XGpioPs_WritePin(&gpio,PIN_DC,1);
	for(i=0;i<2000000;i++) ;
	XGpioPs_WritePin(&gpio,PIN_RES,1);
	/* SPI */
	spiConfig=XSpiPs_LookupConfig(XPAR_PS7_SPI_0_DEVICE_ID);
	XSpiPs_CfgInitialize(&spi,spiConfig,spiConfig->BaseAddress);
	XSpiPs_SetOptions(&spi,XSPIPS_MASTER_OPTION);
	XSpiPs_SetClkPrescaler(&spi,XSPIPS_CLK_PRESCALE_64); //2.6 MHz
	/* konfiguracio */
	XGpioPs_WritePin(&gpio,PIN_DC,0);
	XSpiPs_PolledTransfer(&spi,initCommands,NULL,25);
	XGpioPs_WritePin(&gpio,PIN_DC,1);
	/* bekapcs */
	XGpioPs_WritePin(&gpio,PIN_VBAT,0);
	oledClear();
	oledIsOn=1;
}

void oledPowerOff(void){
	volatile uint32_t i;
	if(!oledIsOn) return;
	XGpioPs_WritePin(&gpio,PIN_VBAT,1);
	for(i=0;i<10000000;i++) ;
	XGpioPs_WritePin(&gpio,PIN_VDD,1);
	oledIsOn=0;
}

void oledUpdate(void){
	uint8_t commands[6]={0x21,0x00,0x7F,0x22,0x00,0x03};
	XGpioPs_WritePin(&gpio,PIN_DC,0);
	XSpiPs_PolledTransfer(&spi,commands,NULL,6);
	XGpioPs_WritePin(&gpio,PIN_DC,1);
	XSpiPs_PolledTransfer(&spi,oledFrameBuffer,NULL,512);
}

void oledClear(void){
	memset(oledFrameBuffer,0,512);
	oledUpdate();
}

void oledSetPixel(uint8_t x, uint8_t y){
	if((x>127)||(y>31)) return;
	oledFrameBuffer[x+((y>>3)<<7)]|=(1<<(y&7));
}

void oledClearPixel(uint8_t x, uint8_t y){
	if((x>127)||(y>31)) return;
	oledFrameBuffer[x+((y>>3)<<7)]&=~(1<<(y&7));
}

void oledInvert(void){
	static uint8_t negative=0;
	uint8_t command;
	if(negative){
		command=0xA6;
		negative=0;
	}
	else{
		command=0xA7;
		negative=1;
	}
	XGpioPs_WritePin(&gpio,PIN_DC,0);
	XSpiPs_PolledTransfer(&spi,&command,NULL,1);
	XGpioPs_WritePin(&gpio,PIN_DC,1);
}

void oledSetCursor(uint8_t x, uint8_t y){
	cursorX=(x>123)?123:x;
	cursorY=(y>24)?24:y;
}

void oledPrintChar(char ch){
	uint16_t byte;
	uint8_t i;
	byte=((cursorY>>3)==0)?(cursorX):(cursorX+((cursorY>>3)<<7));
	for(i=0;i<5;i++) oledFrameBuffer[byte+i]=font[(ch-0x20)*5+i];
	cursorX+=6;
	if((cursorX>123)&&(cursorY>=24)){
		cursorX=128;
		cursorY=24;
	}
	else{
		if(cursorX>123){
			cursorX=0;
			cursorY+=8;
		}
		if(cursorY>24)
			cursorY=24;
	}
}

void oledPrintText(char *str){
	while(*str) oledPrintChar(*(str++));
}

void oledDrawLine(uint8_t x1, uint8_t y1, uint8_t x2, uint8_t y2){
	int16_t dx, dy, incx, incy, incx_parallel, incy_parallel, e1, e2, err, x, y, i;
	if((x1>127)||(y1>31)||(x2>127)||(y2>31)) return;
	dx=x2-x1;
	dy=y2-y1;
	incx=(dx>0)?1:((dx<0)?-1:0);
	incy=(dy>0)?1:((dy<0)?-1:0);
	if(dx<0) dx=-dx;
	if(dy<0) dy=-dy;
	if(dx>dy){
		incx_parallel=incx;
		incy_parallel=0;
		e1=dy;
		e2=dx;
	}
	else{
		incx_parallel=0;
		incy_parallel=incy;
		e1=dx;
		e2=dy;
	}
	x=x1;
	y=y1;
	err=e2>>1;
	oledSetPixel(x,y);
	for(i=0;i<e2;i++){
		err-=e1;
		if(err<0){
			err+=e2;
			x+=incx;
			y+=incy;
		}
		else{
			x+=incx_parallel;
			y+=incy_parallel;
		}
		oledSetPixel(x,y);
	}
}

void oledDrawCircle(uint8_t cx, uint8_t cy, uint8_t r){
	int16_t d=1-r, ix=0, iy=-2*r, x=0, y=r;
	if((cx+r>127)||(cy+r>31)||(r>cx)||(r>cy)||(r==0)) return;
	oledSetPixel(cx,cy+r);
	oledSetPixel(cx,cy-r);
	oledSetPixel(cx+r,cy);
	oledSetPixel(cx-r,cy);
	while(x<y){
		if(d>=0){
			y--;
			iy+=2;
			d+=iy;
		}
		x++;
		ix+=2;
		d+=ix+1;
		oledSetPixel(cx+x,cy+y);
		oledSetPixel(cx-x,cy+y);
		oledSetPixel(cx+x,cy-y);
		oledSetPixel(cx-x,cy-y);
		oledSetPixel(cx+y,cy+x);
		oledSetPixel(cx-y,cy+x);
		oledSetPixel(cx+y,cy-x);
		oledSetPixel(cx-y,cy-x);
	}
}

void oledDrawFilledCircle(uint8_t cx, uint8_t cy, uint8_t r){
	int32_t d=3-2*r, p=0, q=r;
	int16_t x, y, len;
	if((cx+r>127)||(cy+r>31)||(r>cx)||(r>cy)||(r==0)) return;
	oledDrawCircle(cx,cy,r);
	while(p<=q){
		if(q>0){
			x=cx-p;
			y=cy-q;
			len=2*q;
			if(y<0){len+=y; y=0;}
			oledDrawLine(x,y,x,y+len);
			x=cx+p;
			y=cy-q;
			len=2*q;
			if(y<0){len+=y; y=0;}
			oledDrawLine(x,y,x,y+len);
		}
		if(p>0){
			x=cx-q;
			y=cy-p;
			len=2*p;
			if(y<0){len+=y; y=0;}
			oledDrawLine(x,y,x,y+len);
			x=cx+q;
			y=cy-p;
			len=2*p;
			if(y<0){len+=y; y=0;}
			oledDrawLine(x,y,x,y+len);
		}
		if(d<0){
			d+=p*4+6;
		}
		else{
			d+=(p-q)*4+10;
			q--;
		}
		p++;
	}
}

void oledDrawRectangle(uint8_t x, uint8_t y, uint8_t w, uint8_t h){
	if(((x+w)>127)||((y+h)>31)||(w==0)||(h==0)) return;
	oledDrawLine(x,y,x,y+h);
	oledDrawLine(x+w,y,x+w,y+h);
	oledDrawLine(x,y,x+w,y);
	oledDrawLine(x,y+h,x+w,y+h);
}

void oledDrawFilledRectangle(uint8_t x, uint8_t y, uint8_t w, uint8_t h){
	if(((x+w)>127)||((y+h)>31)||(w==0)||(h==0)) return;
	uint8_t i;
	oledDrawLine(x,y,x,y+h);
	oledDrawLine(x+w,y,x+w,y+h);
	for(i=0;i<=h;i++) oledDrawLine(x,y+i,x+w,y+i);
}
